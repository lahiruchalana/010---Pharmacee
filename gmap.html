<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pharmaceee | google map</title>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <style>
        #map {
            height: 650px;
            width: 100%;
        }
    </style>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <link rel="stylesheet" type="text/css" href="./mapstyle.css" />
</head>
<body>
    <div>
        <nav class="navbar navbar-dark bg-dark" style="height: 70px;">
            <a class="navbar-brand" style="color: white; font-weight: 800;">PHARMACEE</a>
            <div class="form-inline">
                <button type="button" class="btn btn-primary" style="width: 150px;" onClick="location.href='../index.html'">Home</button>
                <div id="dropdownForLanguage" class="dropdown" style="margin-left: 10px;">
                    <button id="languageSelector" class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton2" data-bs-toggle="dropdown" aria-expanded="false">
                        Select Language
                    </button>
                    <ul id="languageDropdown" class="dropdown-menu dropdown-menu-dark" aria-labelledby="dropdownMenuButton2">
                        <li><a id="Sinhala" class="dropdown-item" href="#">සිංහල</a></li>
                        <li><a id="English" class="dropdown-item" href="#">English</a></li>
                        <li><a id="Tamil" class="dropdown-item" href="#">தமிழ்</a></li>
                    </ul>
                </div>
                <!-- <input id="pac-input" class="controls" type="text" placeholder="Search Box"/> -->
                <!-- <button id="myLocationButton" type="button" class="btn btn-primary" style="width: 250px; margin-right: -1100px; margin-top: 10px;">My Location</button> -->
            </div> 
        </nav>
    </div>
    <select id="radius_km" style="z-index: 100;">
        <option value=1>1km</option>
        <option value=2>2km</option>
        <option value=5>5km</option>
        <option value=30>30km</option>
    </select>

    <div id="map" style="z-index: 0;"></div>
    <script>
        function initMap() {
            var map = null;
            var radius_circle = null;
            var markers_on_map = [];
            
            //all_locations is just a sample, you will probably load those from database
            var all_locations = [
                {type: "Restaurant", name: "Restaurant 1", lat: 40.723080, lng: -73.984340},
                {type: "School", name: "School 1", lat: 40.724705, lng: -73.986611},
                {type: "School", name: "School 2", lat: 40.724165, lng: -73.983883},
                {type: "Restaurant", name: "Restaurant 2", lat: 40.721819, lng: -73.991358},
                {type: "School", name: "School 3", lat: 40.732056, lng: -73.998683}
            ];

            //initialize map on document ready
            $(document).ready(function(){
                var latlng = new google.maps.LatLng(6.9271, 79.8612); //you can use any location as center on map startup
                var myOptions = {
                    zoom: 14,
                    center: latlng,
                    mapTypeControl: true,
                    mapTypeControlOptions: {style: google.maps.MapTypeControlStyle.DROPDOWN_MENU},
                    navigationControl: true,
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                };
                map = new google.maps.Map(document.getElementById("map"), myOptions);
                
                google.maps.event.addListener(map, 'click', showCloseLocations);
            });
            
            function showCloseLocations(e) {
                var i;
                var radius_km = $('#radius_km').val();
                var address = $('#address').val();

                //remove all radii and markers from map before displaying new ones
                if (radius_circle) {
                    radius_circle.setMap(null);
                    radius_circle = null;
                }
                for (i = 0; i < markers_on_map.length; i++) {
                    if (markers_on_map[i]) {
                        markers_on_map[i].setMap(null);
                        markers_on_map[i] = null;
                    }
                }
                
                var address_lat_lng = e.latLng;
                radius_circle = new google.maps.Circle({
                    center: address_lat_lng,
                    radius: radius_km * 1000,
                    clickable: false,
                    map: map
                });
                if(radius_circle) map.fitBounds(radius_circle.getBounds());
                // Default table --> English Table
            getLanguageByData("english")

            // Click on Sinhala language button
            $('#Sinhala').click(function(){
                let language = "sinhala"
                getLanguageByData(language)
            });

            // Click on English language button
            $('#English').click(function(){
                let language = "english"
                getLanguageByData(language)
            });

            // Click on Tamil language button
            $('#Tamil').click(function(){
                let language = "tamil"
                getLanguageByData(language)
            });
            // function to get lat lons with info with english, sinhala and tamil language
                function getLanguageByData(language) {
                $.getJSON(`Data/${language}.json`, function (data) {
                    $.each(data, function (key, value) {
                        let infoWindow = new google.maps.InfoWindow();
                        var latitude = parseFloat(value.Latitude)
                        var longitude = parseFloat(value.Longitude)
                        var coords = {lat:latitude,lng:longitude}
                        var name = value.Name
                        var address = value.Address
                        var phone = value.Phone
                        var whatsApp = value.WhatsApp
                        var viber = value.Viber
                        var info = `<h4>${name}</h4>` 
                        + `<h6>${address}</h6>` 
                        + `<h6>Phone : ${phone}</h6>`
                        + `<h6>WhatsApp : ${whatsApp}</h6>` 
                        + `<h6>Viber : ${viber}</h6>`
                        var marker_lat_lng = new google.maps.LatLng(latitude, longitude);
                        var distance_from_location = google.maps.geometry.spherical.computeDistanceBetween(address_lat_lng, marker_lat_lng); //distance in meters between your location and the marker
                        if (distance_from_location <= radius_km * 1000) {
                            var new_marker = new google.maps.Marker({
                                position: marker_lat_lng,
                                map: map,
                                title: name
                            });
                            google.maps.event.addListener(new_marker, 'click', function () {
                                const pos = {
                                    lat: latitude,
                                    lng: longitude,
                                };
                                infoWindow.setPosition(pos);
                                infoWindow.setContent(`${info}  <h5> Distance From Selected Point: ${distance_from_location/1000}  Km </h5>`);
                                infoWindow.open(map);
                                map.setCenter(pos);
                            });
                            markers_on_map.push(new_marker);
                        }
                    })(all_locations[j]);
                });
                }
            }

            // find my location
            let infoWindow = new google.maps.InfoWindow();
            const locationButton = document.getElementById("myLocationButton");
            locationButton.textContent = "My Current Location";
            locationButton.classList.add("custom-map-control-button");
            map.controls[google.maps.ControlPosition.TOP_CENTER].push(locationButton);
            locationButton.addEventListener("click", () => {
                // Try HTML5 geolocation.
                if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };
                    infoWindow.setPosition(pos);
                    infoWindow.setContent("<h6>Your Location...</h6>");
                    infoWindow.open(map);
                    map.setCenter(pos);
                    },
                    () => {
                    handleLocationError(true, infoWindow, map.getCenter());
                    }
                );
                } else {
                // Browser doesn't support Geolocation
                handleLocationError(false, infoWindow, map.getCenter());
                }
            });

            //start here search function
            //but search function (google Place API) is not working without add a payment methods
            const input = document.getElementById("pac-input");
            map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
            var autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.bindTo('bounds', map);
            autocomplete.addListener('place_changed', function() {
            infowindow.close();
            // markers are not visible when function calling
            marker.setVisible(false);
            var place = autocomplete.getPlace();
            if (!place.geometry) {
                window.alert("Autocomplete's returned place contains no geometry");
                return;
            }
            // If the place has a geometry, then present it on a map.
            if (place.geometry.viewport) {
                map.fitBounds(place.geometry.viewport);
            } else {
                map.setCenter(place.geometry.location);
                map.setZoom(17);
            }
            marker.setIcon(({
                url: place.icon,
                size: new google.maps.Size(71, 71),
                origin: new google.maps.Point(0, 0),
                anchor: new google.maps.Point(17, 34),
                scaledSize: new google.maps.Size(35, 35)
            }));
            marker.setPosition(place.geometry.location);
            marker.setVisible(true);
            var address = '';
            if (place.address_components) {
                address = [
                    (place.address_components[0] && place.address_components[0].short_name || ''),
                    (place.address_components[1] && place.address_components[1].short_name || ''),
                    (place.address_components[2] && place.address_components[2].short_name || '')
                ].join(' ');
            }
            infowindow.setContent('<div><strong>' + place.name + '</strong><br>' + address);
            infowindow.open(map, marker);
            
            });
        }

        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(
            browserHasGeolocation
            ? "Error: The Geolocation service failed."
            : "Error: Your browser doesn't support geolocation."
        );
        infoWindow.open(map);
        }

        $('#dropdownForLanguage').click(function(){
        $('#languageDropdown').toggleClass('show');
        });
    </script>
    <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyACc5lUcG3lHSvqroAEOMaVOSUec9sr5fA&libraries=places&callback=initMap">
    </script>
</body>
</html>